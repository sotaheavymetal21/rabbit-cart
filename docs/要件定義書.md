# 要件定義書:rabbit-cart (うさぎECサイト)

## 1. プロジェクト概要

### 1.1 目的
モダンフロントエンド技術(Next.js App Router, TypeScript)の**基礎を体系的に学習**することを目的とした、うさぎモチーフの簡易ECサイト。

### 1.2 学習目標
- ✅ React の基本(コンポーネント、props、state、hooks)
- ✅ Next.js App Router の理解(Server/Client Components の使い分け)
- ✅ TypeScript による型安全な開発
- ✅ Zustand でのシンプルな状態管理
- ✅ Supabase を使ったバックエンド連携(Auth, DB)
- ✅ フォームバリデーション(React Hook Form + Zod)
- ✅ レスポンシブデザイン(Tailwind CSS)

### 1.3 対象ユーザー
うさぎグッズを購入したい一般ユーザー(ログイン必須・任意機能あり)

---

## 2. システム構成・技術スタック

### 2.1 フロントエンド技術

| カテゴリ | 技術選定 | バージョン | 選定理由 |
|:---|:---|:---|:---|
| **UI Library** | **React** | 18.x | UIを構築するための基盤ライブラリ |
| **Framework** | **Next.js (App Router)** | 15.x | Reactフレームワーク、SSR/SSG対応、ファイルベースルーティング |
| **Language** | **TypeScript** | 5.x | 型安全性、エディタ補完、バグ削減 |
| **UI Components** | **Material UI (MUI)** | 6.x | 高品質で統一されたReactコンポーネントライブラリ |
| **Styling** | **Tailwind CSS** | 3.x | ユーティリティファーストCSS、レスポンシブ対応が容易 |
| **State Management** | **Zustand** | 5.x | シンプルで学習コストが低い、persist機能あり |
| **Form Management** | **React Hook Form** | 7.x | 再レンダリングを抑えたパフォーマンスの良いフォーム管理 |
| **Validation** | **Zod** | 3.x | TypeScriptと統合されたスキーマバリデーション、型推論 |

### 2.2 バックエンド技術

| カテゴリ | 技術選定 | バージョン | 選定理由 |
|:---|:---|:---|:---|
| **Language** | **Go** | 1.24.x | 高速、並行処理に強い、静的型付け |
| **Framework** | **Gin** | 1.x | 高速なHTTPウェブフレームワーク |
| **ORM** | **GORM** | Latest | Go標準的なORM、生産性向上 |
| **Database** | **PostgreSQL** | 15.x | 信頼性の高いリレーショナルDB |
| **Authentication** | **JWT (Go)** | - | 自前実装によるセッション/トークン管理 |
| **Migration** | **Atlas** | Latest | モダンなDBマイグレーションツール |

### 2.3 開発環境・ツール

| カテゴリ | 技術選定 | バージョン | 選定理由 |
|:---|:---|:---|:---|
| **Runtime** | **Node.js** | 20.x LTS | JavaScript実行環境 (Frontend) |
| **Compiler** | **Go** | 1.24.x | Goコンパイラ (Backend) |
| **Package Manager** | **pnpm** | 9.x | フロントエンド用 |
| **Containerization** | **Docker** | Latest | 環境差異の吸収、DB等の起動 |
| **Version Control** | **Git** | - | ソースコード管理 |

### 2.4 デプロイ・ホスティング

| カテゴリ | 技術選定 | 備考 |
|:---|:---|:---|
| **Frontend** | **Vercel** | Next.js推奨 |
| **Backend** | **Cloud Run (想定)** | コンテナベースのデプロイ |
| **Database** | **Managed PostgreSQL** | AWS RDS, Google Cloud SQL 等 |

---

## 3. 機能要件(Functional Requirements)

### 3.1 認証機能(Auth)

#### 対象
全ユーザー

#### 機能詳細

##### 3.1.1 サインアップ(新規登録)
- **画面:** `/signup`
- **処理フロー:**
  1. フォームバリデーション(Frontend)
  2. **Go Backend API (`POST /api/signup`)** 呼び出し
  3. Go側でパスワードハッシュ化(bcrypt)、DB保存
  4. 成功時: `/login` へリダイレクト

##### 3.1.2 サインイン(ログイン)
- **画面:** `/login`
- **処理フロー:**
  1. フォームバリデーション
  2. **Go Backend API (`POST /api/login`)** 呼び出し
  3. Go側でパスワード検証、JWT生成
  4. HTTP-Only Cookie にJWTを設定してレスポンス
  5. 成功時: `/` へリダイレクト

##### 3.1.3 サインアウト(ログアウト)
- **画面:** ヘッダーのログアウトボタン
- **処理フロー:**
  1. **Go Backend API (`POST /api/logout`)** 呼び出し
  2. Cookie の削除
  3. `/login` へリダイレクト

#### 技術的制約
- **Supabase Auth は使用しない**
- パスワードは `bcrypt` 等でハッシュ化して保存
- セッション管理は JWT (HTTP-Only Cookie) を使用

---

### 3.2 商品閲覧機能(Products)

#### 対象
全ユーザー(未ログインでも閲覧可能)

#### 機能詳細

##### 3.2.1 商品一覧表示
- **画面:** `/` (ルート)
- **データ取得:**
  - Server Components (または Client) から **Go Backend API (`GET /api/products`)** を呼び出し
  - JSONレスポンスを表示

##### 3.2.2 商品詳細表示
- **画面:** `/products/[id]`
- **データ取得:**
  - **Go Backend API (`GET /api/products/:id`)** を呼び出し

#### 技術的制約
- API との通信は `fetch` を使用

---

### 3.3 カート機能(Cart)

(変更なし - 基本的にFrontendの状態管理のため)
※ ただし、ログイン時にDBのカートと同期するなどの要件があれば追加検討しますが、現状はLocal Storage維持とします。

---

### 3.4 注文機能(Checkout)

#### 対象
ログインユーザーのみ

#### 機能詳細

##### 3.4.1 注文情報入力
- **画面:** `/checkout`

##### 3.4.2 注文確定処理
- **処理フロー:**
  1. フォームバリデーション
  2. **Go Backend API (`POST /api/orders`)** へデータ送信
  3. Go側で:
     - 在庫チェック
     - 注文確定(Transaction)
     - カート内商品情報に基づき `order_items` 作成
  4. 成功時: 完了画面へ

---

### 3.5 注文履歴機能(Order History)

#### 対象
ログインユーザーのみ

#### 機能詳細

##### 3.5.1 注文履歴一覧表示
- **画面:** `/orders`
- **データ取得:** **Go Backend API (`GET /api/orders`)**

##### 3.5.2 注文詳細表示
- **画面:** `/orders/[id]`
- **データ取得:** **Go Backend API (`GET /api/orders/:id`)**

---

## 4. データモデル

### 4.1 データベース設計 (PostgreSQL)

Atlas または GORM Auto Migrate を使用して管理。

#### Users
- `id` (UUID/Auto Increment)
- `email` (String, Unique)
- `password_hash` (String)
- `created_at`

#### Products
- `id`
- `name`
- `description`
- `price`
- `stock`
- `image_url`

#### Orders
- `id`
- `user_id`
- `total_amount`
- `status`
- `address` (JSONB or Columns)

#### OrderItems
- `id`
- `order_id`
- `product_id`
- `quantity`
- `price`

### 4.2 セキュリティ
- **Go Backend 側で認証/認可を制御**
- RLS は使用しない (Goアプリケーション上のロジックで制御)


---

## 5. 画面設計

### 5.1 サイトマップ

```
rabbit-cart
│
├─ / (商品一覧) ★全員
├─ /products/[id] (商品詳細) ★全員
├─ /cart (カート) ★全員
├─ /checkout (注文入力) ★ログイン必須
├─ /checkout/complete (注文完了) ★ログイン必須
├─ /orders (注文履歴一覧) ★ログイン必須
├─ /orders/[id] (注文詳細) ★ログイン必須
├─ /login (ログイン) ★未ログインのみ
└─ /signup (新規登録) ★未ログインのみ
```

---

### 5.2 共通レイアウト

#### Header(全ページ共通)
- ロゴ「🐰 rabbit-cart」
- ナビゲーション:
  - 「商品一覧」リンク
  - 「カート」リンク(カート内アイテム数バッジ表示)
  - ログイン済み:「注文履歴」「ログアウト」
  - 未ログイン:「ログイン」「新規登録」

#### Footer(全ページ共通)
- コピーライト「© 2024 rabbit-cart」
- 簡易的な運営情報リンク(オプション)

---

### 5.3 各画面のワイヤーフレーム概要

#### `/` (商品一覧)
```
[Header]
─────────────────────
タイトル: うさぎグッズ一覧🐰

[商品カード] [商品カード] [商品カード]
[商品カード] [商品カード] [商品カード]
...

[Footer]
```

#### `/products/[id]` (商品詳細)
```
[Header]
─────────────────────
[商品画像(大)]  商品名
              価格: ¥2,980
              説明: ふわふわの...
              在庫: 10個
              
              [カートに入れる🐰]

[Footer]
```

#### `/cart` (カート)
```
[Header]
─────────────────────
カート🛒

商品1 [画像] 名前 ¥1,200 × [2] [+][-][削除]
商品2 [画像] 名前 ¥2,980 × [1] [+][-][削除]

─────────────────────
合計: ¥5,160

[注文へ進む]

[Footer]
```

#### `/checkout` (注文入力)
```
[Header]
─────────────────────
注文情報入力

【カート内容】
商品1 × 2 ¥2,400
商品2 × 1 ¥2,980
合計: ¥5,380

【配送先情報】
氏名: [     ]
郵便番号: [     ]
都道府県: [選択]
...

[注文を確定する🐰]

[Footer]
```

---

## 6. 非機能要件

### 6.1 レスポンシブデザイン
- **ブレークポイント(Tailwind CSS):**
  - SP: `< 640px` (デフォルト)
  - Tablet: `md: 768px〜`
  - PC: `lg: 1024px〜`
- **対応:**
  - 商品グリッド:SP(1列)、Tablet(2列)、PC(3-4列)
  - ヘッダーナビゲーション:SP(ハンバーガーメニュー)、PC(横並び)

### 6.2 パフォーマンス
- **画像最適化:**
  - `next/image` コンポーネント使用
  - WebP/AVIF への自動変換
  - Lazy Loading 適用
- **レンダリング戦略:**
  - 商品一覧・詳細:Server Components(SSR)
  - カート:Client Components(Zustand 使用)
  - 認証フォーム:Client Components

### 6.3 セキュリティ
- **認証:**
  - Supabase Auth による安全なセッション管理
  - Cookie ベース、HttpOnly 設定
- **データアクセス:**
  - Supabase RLS でDBレベルのアクセス制御
  - バックエンドAPIは原則不要
- **バリデーション:**
  - クライアント側:Zod(UX向上)
  - サーバー側:Supabase RLS(セキュリティ担保)

### 6.4 アクセシビリティ(基本対応)
- セマンティックHTML使用(`<header>`, `<main>`, `<footer>`)
- ボタンに適切な `aria-label` 設定
- フォーム要素に `<label>` 関連付け
- キーボード操作可能

### 6.5 ブラウザ対応
- **対象ブラウザ:**
  - Chrome(最新版)
  - Firefox(最新版)
  - Safari(最新版)
  - Edge(最新版)
- **IE11 は非対応**

---

## 7. 開発環境・運用

### 7.1 開発環境構築

#### 必要なソフトウェア
- Docker Desktop
- Node.js 20.x (コンテナ内で使用)
- pnpm 9.x
- Git

#### Docker Compose 構成
```yaml
# docker-compose.yml (概要)
services:
  app:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - .:/app
    ports:
      - "3000:3000"
    command: pnpm dev
```

#### セットアップ手順
```bash
# 1. リポジトリクローン
git clone <repository-url>
cd rabbit-cart

# 2. 依存関係インストール
pnpm install

# 3. 環境変数設定
cp .env.example .env.local
# Supabase の URL, ANON_KEY を設定

# 4. Docker コンテナ起動
docker-compose up -d

# 5. 開発サーバー起動
# http://localhost:3000 でアクセス可能
```

### 7.2 環境変数

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
```

### 7.3 デプロイ
- **ホスティング:** Vercel(推奨)
- **DB/Auth:** Supabase Cloud
- **CI/CD:** GitHub Actions(オプション)

---

## 8. 学習ロードマップ(Phase 1)

### Week 1:環境構築 & 基礎理解
- [ ] Docker 環境構築
- [ ] Next.js プロジェクト初期化
- [ ] Supabase プロジェクト作成、テーブル作成
- [ ] 商品マスタ初期データ投入

### Week 2:商品閲覧機能
- [ ] 商品一覧ページ(Server Components)
- [ ] 商品詳細ページ(Dynamic Routes)
- [ ] MUI + Tailwind CSS でのスタイリング

### Week 3:認証 & カート機能
- [ ] ログイン・サインアップページ
- [ ] Supabase Auth 連携
- [ ] Zustand でカート状態管理
- [ ] カートページ実装

### Week 4:注文機能
- [ ] 注文入力フォーム(React Hook Form + Zod)
- [ ] 注文確定処理(Supabase への書き込み)
- [ ] 注文履歴一覧・詳細

### Week 5:仕上げ
- [ ] レスポンシブ対応確認
- [ ] エラーハンドリング追加
- [ ] 全体的なリファクタリング
- [ ] Vercel へデプロイ

---

## 9. Phase 2 への発展(将来的な拡張)

Phase 1 完成後、以下を段階的に追加していく想定:

- [ ] URL State での商品検索・フィルタリング
- [ ] `error.tsx` / `loading.tsx` の適切な配置
- [ ] 楽観的UI更新(カート追加時)
- [ ] Server Actions での注文処理
- [ ] TanStack Query 導入(Server State 管理)
- [ ] Supabase Realtime(在庫監視)
- [ ] 無限スクロール

---

## 10. 補足・留意事項

### 10.1 決済処理について
- **Phase 1 では決済APIと連携しない**
- 注文確定 = 「購入模倣」であり、実際の支払いは発生しない
- 将来的に Stripe 等を統合する想定

### 10.2 管理者機能について
- **Phase 1 では管理画面は実装しない**
- 商品の追加・編集は Supabase Dashboard から直接操作
- Phase 2 以降で管理画面を追加予定

### 10.3 テストについて
- **Phase 1 では自動テストは最小限**
- 手動テストで動作確認
- Phase 2 以降で Jest/Vitest によるユニットテスト、Playwright による E2E テスト導入